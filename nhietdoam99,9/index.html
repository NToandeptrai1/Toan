<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± H·ªá Th·ªëng T∆∞·ªõi C√¢y</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        .card-header { display: flex; align-items: center; margin-bottom: 20px; }
        .card-icon { font-size: 2em; margin-right: 15px; }
        .card-title { font-size: 1.3em; color: #333; font-weight: 600; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .status-item { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .status-label { font-size: 0.9em; color: #666; margin-bottom: 8px; }
        .moisture-display { text-align: center; margin: 20px 0; }
        .moisture-value { font-size: 4em; font-weight: bold; color: #667eea; margin: 10px 0; }
        .moisture-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin-top: 15px; }
        .moisture-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
            transition: width 0.5s;
            border-radius: 15px;
        }
        .control-buttons { display: grid; gap: 15px; margin-top: 20px; }
        
        .toggle-btn {
            position: relative;
            padding: 15px 25px;
            border: 3px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            background: white;
        }
        
        .toggle-btn:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .toggle-btn:active { transform: scale(0.98); }
        
        .toggle-btn.active {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border-color: #27ae60;
        }
        
        .toggle-btn.inactive {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border-color: #7f8c8d;
        }
        
        .toggle-indicator {
            width: 50px;
            height: 28px;
            background: #ddd;
            border-radius: 14px;
            position: relative;
            transition: all 0.3s;
        }
        
        .toggle-indicator::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-btn.active .toggle-indicator {
            background: #27ae60;
        }
        
        .toggle-btn.active .toggle-indicator::after {
            left: 24px;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.98); }
        .btn-warning { background: #f39c12; color: white; }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .chart-container { position: relative; height: 300px; margin-top: 20px; }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.online { background: #2ecc71; }
        .status-dot.offline { background: #e74c3c; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #e0e0e0; }
        .log-time { color: #666; margin-right: 10px; }
        .config-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8em; }
            .moisture-value { font-size: 3em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± H·ªá Th·ªëng T∆∞·ªõi C√¢y T·ª± ƒê·ªông</h1>
            <p>Gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn t·ª´ xa</p>
        </div>

        <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionText">ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üíß</div>
                    <div class="card-title">ƒê·ªô ·∫®m ƒê·∫•t</div>
                </div>
                <div class="moisture-display">
                    <div class="moisture-value" id="moistureValue">---</div>
                    <div class="status-label">Gi√° tr·ªã c·∫£m bi·∫øn</div>
                    <div class="moisture-bar">
                        <div class="moisture-fill" id="moistureFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <div class="card-title">Tr·∫°ng Th√°i</div>
                </div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">H·ªá th·ªëng</div>
                        <span class="badge" id="systemStatus">---</span>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Ch·∫ø ƒë·ªô</div>
                        <span class="badge" id="autoMode">---</span>
                    </div>
                    <div class="status-item">
                        <div class="status-label">M√°y b∆°m</div>
                        <span class="badge" id="pumpStatus">---</span>
                    </div>
                    <div class="status-item">
                        <div class="status-label">C·∫≠p nh·∫≠t</div>
                        <span class="badge badge-info" id="lastUpdate">---</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üéÆ</div>
                    <div class="card-title">ƒêi·ªÅu Khi·ªÉn</div>
                </div>
                <div class="control-buttons">
                    <button class="toggle-btn" id="pumpToggle" onclick="togglePump()">
                        <span id="pumpToggleText">M√°y B∆°m</span>
                        <div class="toggle-indicator"></div>
                    </button>
                    <button class="toggle-btn" id="autoToggle" onclick="toggleAutoMode()">
                        <span id="autoToggleText">Ch·∫ø ƒê·ªô T·ª± ƒê·ªông</span>
                        <div class="toggle-indicator"></div>
                    </button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üìä</div>
                <div class="card-title">Bi·ªÉu ƒê·ªì ƒê·ªô ·∫®m (24h)</div>
            </div>
            <div class="chart-container">
                <canvas id="moistureChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üìã</div>
                <div class="card-title">Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</div>
            </div>
            <div class="logs-container" id="logsContainer">
                <div>ƒêang t·∫£i...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">‚öôÔ∏è</div>
                <div class="card-title">C·∫•u H√¨nh T∆∞·ªõi</div>
            </div>
            <div>
                <label for="newThreshold">Ng∆∞·ª°ng ƒê·ªô ·∫®m T·ª± ƒê·ªông (0-4095):</label>
                <input type="number" id="newThreshold" class="config-input" min="0" max="4095" value="3000">
                <button class="btn btn-warning" onclick="updateThreshold()">üíæ C·∫≠p Nh·∫≠t Ng∆∞·ª°ng</button>
            </div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Hi·ªán t·∫°i: <span id="currentThreshold">---</span></p>
        </div>
    </div>

    <script>
        const API_URL = 'http://doam.x10.mx/api.php';
        let moistureChart;
        let currentAutoMode = true;
        let currentPumpOn = false;
        let userControlActive = false; // Flag ƒë√°nh d·∫•u ng∆∞·ªùi d√πng ƒëang ƒëi·ªÅu khi·ªÉn
        
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateStatus();
            loadHistory();
            loadLogs();
            loadConfig();
            
            setInterval(updateStatus, 3000);
            setInterval(loadHistory, 15000);
            setInterval(loadLogs, 10000);
        });

        function initChart() {
            const ctx = document.getElementById('moistureChart').getContext('2d');
            moistureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ƒê·ªô ·∫©m ƒë·∫•t',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 4095 }
                    }
                }
            });
        }

       // Thay th·∫ø h√†m updateStatus() hi·ªán t·∫°i
        async function updateStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const result = await response.json();
                
                if (!result || !result.success || !result.data) {
                    console.error('Invalid API response:', result);
                    return;
                }
                
                const data = result.data;
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·ªô ·∫©m v√† c√°c th√¥ng tin kh√°c
                if (document.getElementById('moistureValue')) {
                    document.getElementById('moistureValue').textContent = data.moisture || '---';
                }
                
                // Gi·ªØ nguy√™n logic c·∫≠p nh·∫≠t thanh bar v√† c√°c badge
                const percentage = Math.max(0, Math.min(100, 100 - (data.moisture / 4095 * 100)));
                if (document.getElementById('moistureFill')) {
                    document.getElementById('moistureFill').style.width = percentage + '%';
                }
                
                const statusBadge = document.getElementById('systemStatus');
                if (statusBadge) {
                    statusBadge.textContent = getStatusText(data.status);
                    statusBadge.className = 'badge ' + getStatusClass(data.status);
                }
                
                const modeBadge = document.getElementById('autoMode');
                if (modeBadge) {
                    modeBadge.textContent = data.autoMode ? 'T·ª± ƒê·ªông' : 'Th·ªß C√¥ng';
                    modeBadge.className = 'badge ' + (data.autoMode ? 'badge-success' : 'badge-warning');
                }
                
                const pumpBadge = document.getElementById('pumpStatus');
                if (pumpBadge) {
                    pumpBadge.textContent = data.pumpOn ? 'B·∫¨T' : 'T·∫ÆT';
                    pumpBadge.className = 'badge ' + (data.pumpOn ? 'badge-success' : 'badge-danger');
                }
                
                if (data.timestamp && document.getElementById('lastUpdate')) {
                    const time = new Date(data.timestamp).toLocaleTimeString('vi-VN');
                    document.getElementById('lastUpdate').textContent = time;
                }
                
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                if (dot && text) {
                    dot.className = 'status-dot ' + (data.connected ? 'online' : 'offline');
                    text.textContent = data.connected ? 'ƒêang ho·∫°t ƒë·ªông' : 'M·∫•t k·∫øt n·ªëi';
                }
                
                // LOGIC ƒê·ªíNG B·ªò M·ªöI (ƒê√£ s·ª≠a)
                if (userControlActive) {
                    // N·∫øu ng∆∞·ªùi d√πng v·ª´a nh·∫•n n√∫t, gi·ªØ nguy√™n tr·∫°ng th√°i UI c·ª•c b·ªô 
                    // v√† ch·ªâ ƒë·∫∑t h·∫πn gi·ªù ƒë·ªÉ cho ph√©p ƒë·ªìng b·ªô l·∫°i sau 2 gi√¢y.
                    setTimeout(() => {
                        userControlActive = false;
                        console.log('Re-enabling server sync');
                    }, 2000);
                    
                    // D√íNG QUAN TR·ªåNG: NgƒÉn ch·∫∑n vi·ªác ghi ƒë√® tr·∫°ng th√°i UI ngay l·∫≠p t·ª©c
                    return; 
                } else {
                    // Lu√¥n ƒë·ªìng b·ªô t·ª´ server khi kh√¥ng c√≥ thao t√°c th·ªß c√¥ng
                    if (data.autoMode !== currentAutoMode || data.pumpOn !== currentPumpOn) {
                        console.log('Syncing from server:', {
                            autoMode: data.autoMode,
                            pumpOn: data.pumpOn
                        });
                        currentAutoMode = data.autoMode;
                        currentPumpOn = data.pumpOn;
                        updateToggleButtons();
                    }
                }
                
            } catch (error) {
                console.error('updateStatus Error:', error);
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                if (dot) dot.className = 'status-dot offline';
                if (text) text.textContent = 'L·ªói k·∫øt n·ªëi';
            }
        }

        function updateToggleButtons() {
            const pumpBtn = document.getElementById('pumpToggle');
            const autoBtn = document.getElementById('autoToggle');
            
            if (currentPumpOn) {
                pumpBtn.classList.add('active');
                pumpBtn.classList.remove('inactive');
                document.getElementById('pumpToggleText').textContent = 'üíß M√°y B∆°m: B·∫¨T';
            } else {
                pumpBtn.classList.remove('active');
                pumpBtn.classList.add('inactive');
                document.getElementById('pumpToggleText').textContent = 'üíß M√°y B∆°m: T·∫ÆT';
            }
            
            if (currentAutoMode) {
                autoBtn.classList.add('active');
                autoBtn.classList.remove('inactive');
                document.getElementById('autoToggleText').textContent = 'ü§ñ T·ª± ƒê·ªông: B·∫¨T';
            } else {
                autoBtn.classList.remove('active');
                autoBtn.classList.add('inactive');
                document.getElementById('autoToggleText').textContent = '‚úã T·ª± ƒê·ªông: T·∫ÆT';
            }
        }

        async function togglePump() {
            const newState = !currentPumpOn;
            const command = newState ? 'PUMP_ON' : 'PUMP_OFF';
            
            console.log(`User Toggle Pump: ${currentPumpOn} -> ${newState}`);
            
            // ƒê√°nh d·∫•u user ƒëang ƒëi·ªÅu khi·ªÉn
            userControlActive = true;
            
            currentPumpOn = newState;
            currentAutoMode = false;
            updateToggleButtons();
            
            await sendCommand(command);
        }

        async function toggleAutoMode() {
            const newState = !currentAutoMode;
            const command = newState ? 'AUTO_ON' : 'AUTO_OFF';
            
            console.log(`User Toggle Auto: ${currentAutoMode} -> ${newState}`);
            
            // ƒê√°nh d·∫•u user ƒëang ƒëi·ªÅu khi·ªÉn
            userControlActive = true;
            
            currentAutoMode = newState;
            updateToggleButtons();
            
            await sendCommand(command);
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/history?hours=24&limit=50`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const labels = [];
                    const data = [];
                    
                    result.data.reverse().forEach(item => {
                        const time = new Date(item.created_at).toLocaleTimeString('vi-VN', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        labels.push(time);
                        data.push(item.moisture);
                    });
                    
                    moistureChart.data.labels = labels;
                    moistureChart.data.datasets[0].data = data;
                    moistureChart.update();
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch(`${API_URL}/logs?limit=20`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const container = document.getElementById('logsContainer');
                    container.innerHTML = '';
                    
                    result.data.forEach(log => {
                        const time = new Date(log.executed_at).toLocaleString('vi-VN');
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';
                        entry.innerHTML = `<span class="log-time">[${time}]</span><strong>${log.command}</strong> - ${log.source}`;
                        container.appendChild(entry);
                    });
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_URL}/config`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const threshold = result.data.manual_threshold || 3000;
                    document.getElementById('currentThreshold').textContent = threshold;
                    document.getElementById('newThreshold').value = threshold;
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function updateThreshold() {
            const newValue = parseInt(document.getElementById('newThreshold').value);
            
            if (newValue < 0 || newValue > 4095) {
                alert('Gi√° tr·ªã ph·∫£i trong kho·∫£ng 0-4095');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manual_threshold: newValue })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ª°ng: ${newValue}`);
                    document.getElementById('currentThreshold').textContent = newValue;
                    await sendCommand('RELOAD_CONFIG');
                } else {
                    alert(`‚ùå L·ªói: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ${error.message}`);
            }
        }

        async function sendCommand(command) {
            try {
                const response = await fetch(`${API_URL}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Command sent: ${command}`);
                    setTimeout(updateStatus, 500);
                    setTimeout(loadLogs, 1000);
                } else {
                    console.error(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error(`‚ùå Cannot connect: ${error.message}`);
            }
        }

        function getStatusText(status) {
            const map = {
                'ok': 'B√¨nh Th∆∞·ªùng',
                'watering': 'ƒêang T∆∞·ªõi',
                'critical': 'Nguy C·∫•p',
                'manual': 'Th·ªß C√¥ng'
            };
            return map[status] || status;
        }

        function getStatusClass(status) {
            const map = {
                'ok': 'badge-success',
                'watering': 'badge-warning',
                'critical': 'badge-danger',
                'manual': 'badge-info'
            };
            return map[status] || 'badge-info';
        }
    </script>
</body>
</html>